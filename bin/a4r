#!/usr/bin/env ruby
# encoding: utf-8

require 'rubygems'
require 'aozora4reader'
require 'optparse'

EBB      = 'ebb'
PLATEX   = 'platex -interaction=nonstopmode'
DVIPDFMX = 'dvipdfmx'

def error_and_exit(msg)
  STDERR.puts msg
  exit
end	

def usage()
    error_and_exit "usage: a4r <srcfile>"
end

opt = OptionParser.new
make_pdf = nil
opt.on('-a', '--all', 'generate PDF') do
  make_pdf = true
end

opt.parse!(ARGV)

if ARGV.size != 1
   usage
end

file = ARGV.shift
if !File.exists? file
  error_and_exit "No such file: #{file}"
end

Aozora4Reader.a4r(file)

if make_pdf
  system("#{EBB} *.png")
  system("#{PLATEX} #{file.gsub(/.txt$/,'.tex')}")
  system("#{DVIPDFMX} #{file.gsub(/.txt$/,'.dvi')}")
end


